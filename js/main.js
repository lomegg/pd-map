// server list
window.serverModesList = {
    "kraken1":	"KRAKEN",
    "team1":	"TEAM",
    "team8":	"TEAM",
    "team10":	"TEAM",
    "arena1":	"ARENA",
    "arena2":	"ARENA",
    "arena3":	"ARENA",
    "arena4":	"ARENA",
    "arena5":	"ARENA",
    "arena6":	"ARENA",
    "arena7":	"ARENA",
    "arena8":	"ARENA",
    "arena9":	"ARENA",
    "arena10":	"ARENA",
    "arena11":	"ARENA",
    "arena12":	"ARENA",
    "arena13":	"ARENA",
    "arena14":	"ARENA",
    "arena15":	"ARENA",
    "arena16":	"ARENA",
    "arena17":	"ARENA",
    "arena18":	"ARENA",
    "arena19":	"ARENA",
    "arena20":	"ARENA",
    "fatboy1":	"FATBOY-ARENA",
    "fatboy2":	"FATBOY-ARENA",
    "fatboy3":	"FATBOY-ARENA",
    "fatboy4":	"FATBOY-ARENA",
    "fatboy5":	"FATBOY-ARENA",
    "fatboy6":	"FATBOY-ARENA",
    "fatboy7":	"FATBOY-ARENA",
    "fatboy8":	"FATBOY-ARENA",
    "fatboy9":	"FATBOY-ARENA",
    "fatboy10":	"FATBOY-ARENA",
    "fatboy11":	"FATBOY-ARENA",
    "fatboy12":	"FATBOY-ARENA",
    "fatboy18":	"FATBOY-ARENA",
    "fatboy13":	"FATBOY-ARENA",
    "fatboy15":	"FATBOY-ARENA",
    "fatboy21":	"FATBOY-ARENA",
    "fatboy23":	"FATBOY-ARENA",
    "fatboy16":	"FATBOY-ARENA",
    "fatboy17":	"FATBOY-ARENA",
    "fatboy34":	"FATBOY-ARENA",
    "fatboy35":	"FATBOY-ARENA",
    "fatboy36":	"FATBOY-ARENA",
    "fatboy37":	"FATBOY-ARENA",
    "fatboy38":	"FATBOY-ARENA",
    "fatboy39":	"FATBOY-ARENA",
    "fatboy40":	"FATBOY-ARENA",
    "fatboy41":	"FATBOY-ARENA",
    "fatboy42":	"FATBOY-ARENA",
    "fatboy43":	"FATBOY-ARENA",
    "fatboy44":	"FATBOY-ARENA",
    "fatboy45":	"FATBOY-ARENA",
    "fatboy19":	"FATBOY-ARENA",
    "fatboy14":	"FATBOY-ARENA",
    "fatboy20":	"FATBOY-ARENA",
    "fatboy22":	"FATBOY-ARENA",
    "fatboy24":	"FATBOY-ARENA",
    "fatboy25":	"FATBOY-ARENA",
    "fatboy26":	"FATBOY-ARENA",
    "fatboy27":	"FATBOY-ARENA",
    "fatboy28":	"FATBOY-ARENA",
    "fatboy29":	"FATBOY-ARENA",
    "fatboy30":	"FATBOY-ARENA",
    "fatboy31":	"FATBOY-ARENA",
    "fatboy32":	"FATBOY-ARENA",
    "fatboy33":	"FATBOY-ARENA",
    "fatboy46":	"FATBOY-ARENA",
    "fatboy47":	"FATBOY-ARENA",
    "snakerdish1":	"SNAKERDISH",
    "crazy1":	"CRAZY-FFA",
    "exp1":	"EXPERIMENTAL",
    "fastfood1":	"FASTFOOD",
    "fastfood2":	"FASTFOOD",
    "viruswarsffa6":	"VIRUSWARSFFA",
    "blackhole1":	"BLACKHOLE",
    "blackhole4":	"BLACKHOLE",
    "blackhole5":	"BLACKHOLE",
    "blackhole6":	"BLACKHOLE",
    "blackhole7":	"BLACKHOLE",
    "blackhole8":	"BLACKHOLE",
    "blackhole9":	"BLACKHOLE",
    "solar":	"FFA",
    "galaxy":	"FFA",
    "earth":	"FFA",
    "universe":	"FFA",
    "russia":	"FFA",
    "nolimit":	"FFA",
    "tunnel":	"FFA",
    "sky":	"FFA",
    "oneshotffa1":	"ONESHOT",
    "oneshotmegasplit1":	"ONESHOT",
    "oneshotmegasplit20":	"ONESHOT",
    "space1":	"SPACE",
    "crazysplit1":	"CRAZYSPLIT",
    "crazysplit2":	"CRAZYSPLIT",
    "crazysplit3":	"CRAZYSPLIT",
    "crazysplit4":	"CRAZYSPLIT",
    "crazysplit5":	"CRAZYSPLIT",
    "crazysplit6":	"CRAZYSPLIT",
    "crazysplit7":	"CRAZYSPLIT",
    "crazysplit8":	"CRAZYSPLIT",
    "crazysplit9":	"CRAZYSPLIT",
    "crazysplit10":	"CRAZYSPLIT",
    "crazysplit11":	"CRAZYSPLIT",
    "crazysplit12":	"CRAZYSPLIT",
    "crazysplit13":	"CRAZYSPLIT",
    "crazysplit14":	"CRAZYSPLIT",
    "crazysplit15":	"CRAZYSPLIT",
    "crazysplit16":	"CRAZYSPLIT",
    "crazysplit17":	"CRAZYSPLIT",
    "crazysplit18":	"CRAZYSPLIT",
    "crazysplit19":	"CRAZYSPLIT",
    "crazysplit20":	"CRAZYSPLIT",
    "crazysplit21":	"CRAZYSPLIT",
    "eatforspeed1":	"EATFORSPEED",
    "eatforspeed5":	"EATFORSPEED",
    "special1":	"SPECIAL",
    "special2":	"SPECIAL",
    "special3":	"SPECIAL",
    "special4":	"SPECIAL",
    "special5":	"SPECIAL",
    "megasplit1":	"MEGASPLIT",
    "megasplit2":	"MEGASPLIT",
    "megasplit3":	"MEGASPLIT",
    "megasplit4":	"MEGASPLIT",
    "megasplit10":	"MEGASPLIT",
    "megasplit27":	"MEGASPLIT",
    "megasplit40":	"MEGASPLIT",
    "megasplit5k1":	"MEGASPLIT5K",
    "megasplit5k2":	"MEGASPLIT5K",
    "megasplit5k3":	"MEGASPLIT5K",
    "megasplit5k4":	"MEGASPLIT5K",
    "megasplit5k5":	"MEGASPLIT5K",
    "megasplit5k6":	"MEGASPLIT5K",
    "megasplit5k7":	"MEGASPLIT5K",
    "megasplit5k8":	"MEGASPLIT5K",
    "megasplit5k9":	"MEGASPLIT5K",
    "megasplit5k10":	"MEGASPLIT5K",
    "megasplit5k18":	"MEGASPLIT5K",
    "hardcore1":	"HARDCORE",
    "hardcore2":	"HARDCORE",
    "hardcore3":	"HARDCORE",
    "hardcore5":	"HARDCORE",
    "hardcore6":	"HARDCORE",
    "hardcore7":	"HARDCORE",
    "hardcore8":	"HARDCORE",
    "hardcore9":	"HARDCORE",
    "hardcore10":	"HARDCORE",
    "hardcore12":	"HARDCORE",
    "hardcore26":	"HARDCORE",
    "extreme7":	"HARDCORE",
    "hardcoreexp1":	"HARDCOREEXP",
    "hardcoreexp2":	"HARDCOREEXP",
    "hardcoreexp3":	"HARDCOREEXP",
    "hardcoreexp4":	"HARDCOREEXP",
    "hardcoreexp5":	"HARDCOREEXP",
    "hardcoreexp6":	"HARDCOREEXP",
    "hardcoreexp7":	"HARDCOREEXP",
    "hardcoreexp8":	"HARDCOREEXP",
    "hardcoreexp9":	"HARDCOREEXP",
    "hardcoreexp10":	"HARDCOREEXP",
    "hardcoreexp21":	"HARDCOREEXP",
    "hardcoreexp22":	"HARDCOREEXP",
    "hardcoreexp41":	"HARDCOREEXP",
    "hardcoreexp50":	"HARDCOREEXP",
    "zombie1":	"ZOMBIE-FFA",
    "dm1":	"DEATHMATCH",
    "luna":	"FFA",
    "venera":	"FFA",
    "saturn":	"FFA",
    "slowserver":	"FFA",
    "paris":	"FFA",
    "turkey":	"FFA",
    "amsterdam":	"FFA",
    "moscow":	"FFA",
    "canada":	"FFA",
    "london":	"FFA",
    "siberia":	"FFA",
    "kiev":	"FFA",
    "minsk":	"FFA",
    "usa1-newyork":	"FFA",
    "usa2-newyork":	"FFA",
    "usa3-newyork":	"FFA",
    "singapore1":	"FFA",
    "toronto":	"FFA",
    "clanhousew.w":	"CLANHOUSE",
    "clanhouse18-25":	"CLANHOUSE",
    "clanhousefff":	"CLANHOUSE",
    "clanhousefbi":	"CLANHOUSE",
    "clanhouse•••":	"CLANHOUSE",
    "clanhousedsm":	"CLANHOUSE",
    "clanhousezzz":	"CLANHOUSE",
    "clanhouse72":	"CLANHOUSE",
    "clanhousezaw":	"CLANHOUSE",
    "clanhousepvl":	"CLANHOUSE",
    "clanhousedead":	"CLANHOUSE",
    "clanhouser2b":	"CLANHOUSE",
    "clanhouseng":	"CLANHOUSE",
    "clanhouseyolka":	"CLANHOUSE",
    "clanhousewin":	"CLANHOUSE",
    "clanhousefan":	"CLANHOUSE",
    "clanhouseup":	"CLANHOUSE",
    "clanhouserzr":	"CLANHOUSE",
    "clanhousehawk":	"CLANHOUSE",
    "clanhousezogo":	"CLANHOUSE",
    "clanhousegyg":	"CLANHOUSE",
    "clanhousepav":	"CLANHOUSE",
    "clanhousepride":	"CLANHOUSE",
    "clanhouseaob":	"CLANHOUSE",
    "clanhousenoteam1":	"CLANHOUSE",
    "clanhousetournament":	"CLANHOUSE",
    "clanhousetest":	"CLANHOUSE"
};
window.serverImportanceList = {
    "kraken1":	"1",
    "team1":	"1",
    "team8":	"1",
    "team10":	"1",
    "arena1":	"1",
    "arena2":	"1",
    "arena3":	"1",
    "arena4":	"1",
    "arena5":	"1",
    "arena6":	"1",
    "arena7":	"1",
    "arena8":	"1",
    "arena9":	"1",
    "arena10":	"1",
    "arena11":	"1",
    "arena12":	"1",
    "arena13":	"1",
    "arena14":	"1",
    "arena15":	"1",
    "arena16":	"1",
    "arena17":	"1",
    "arena18":	"1",
    "arena19":	"1",
    "arena20":	"1",
    "fatboy1":	"1",
    "fatboy2":	"1",
    "fatboy3":	"1",
    "fatboy4":	"1",
    "fatboy5":	"1",
    "fatboy6":	"1",
    "fatboy7":	"1",
    "fatboy8":	"1",
    "fatboy9":	"1",
    "fatboy10":	"1",
    "fatboy11":	"1",
    "fatboy12":	"1",
    "fatboy18":	"1",
    "fatboy13":	"1",
    "fatboy15":	"1",
    "fatboy21":	"1",
    "fatboy23":	"1",
    "fatboy16":	"1",
    "fatboy17":	"1",
    "fatboy34":	"1",
    "fatboy35":	"1",
    "fatboy36":	"1",
    "fatboy37":	"1",
    "fatboy38":	"1",
    "fatboy39":	"1",
    "fatboy40":	"1",
    "fatboy41":	"1",
    "fatboy42":	"1",
    "fatboy43":	"1",
    "fatboy44":	"1",
    "fatboy45":	"1",
    "fatboy19":	"1",
    "fatboy14":	"1",
    "fatboy20":	"1",
    "fatboy22":	"1",
    "fatboy24":	"1",
    "fatboy25":	"1",
    "fatboy26":	"1",
    "fatboy27":	"1",
    "fatboy28":	"1",
    "fatboy29":	"1",
    "fatboy30":	"1",
    "fatboy31":	"1",
    "fatboy32":	"1",
    "fatboy33":	"1",
    "fatboy46":	"1",
    "fatboy47":	"1",
    "snakerdish1":	"1",
    "crazy1":	"1",
    "exp1":	"1",
    "fastfood1":	"1",
    "fastfood2":	"1",
    "viruswarsffa6":	"1",
    "blackhole1":	"1",
    "blackhole4":	"1",
    "blackhole5":	"1",
    "blackhole6":	"1",
    "blackhole7":	"1",
    "blackhole8":	"1",
    "blackhole9":	"1",
    "solar":	"3",
    "galaxy":	"2",
    "earth":	"1",
    "universe":	"2",
    "russia":	"1",
    "nolimit":	"1",
    "tunnel":	"1",
    "sky":	"1",
    "oneshotffa1":	"1",
    "oneshotmegasplit1":	"1",
    "oneshotmegasplit20":	"1",
    "space1":	"1",
    "crazysplit1":	"1",
    "crazysplit2":	"1",
    "crazysplit3":	"1",
    "crazysplit4":	"1",
    "crazysplit5":	"1",
    "crazysplit6":	"1",
    "crazysplit7":	"1",
    "crazysplit8":	"1",
    "crazysplit9":	"1",
    "crazysplit10":	"1",
    "crazysplit11":	"1",
    "crazysplit12":	"1",
    "crazysplit13":	"1",
    "crazysplit14":	"1",
    "crazysplit15":	"1",
    "crazysplit16":	"1",
    "crazysplit17":	"1",
    "crazysplit18":	"1",
    "crazysplit19":	"1",
    "crazysplit20":	"1",
    "crazysplit21":	"1",
    "eatforspeed1":	"1",
    "eatforspeed5":	"1",
    "special1":	"1",
    "special2":	"1",
    "special3":	"1",
    "special4":	"1",
    "special5":	"1",
    "megasplit1":	"2",
    "megasplit2":	"1",
    "megasplit3":	"1",
    "megasplit4":	"1",
    "megasplit10":	"1",
    "megasplit27":	"1",
    "megasplit40":	"1",
    "megasplit5k1":	"1",
    "megasplit5k2":	"1",
    "megasplit5k3":	"1",
    "megasplit5k4":	"1",
    "megasplit5k5":	"1",
    "megasplit5k6":	"1",
    "megasplit5k7":	"1",
    "megasplit5k8":	"1",
    "megasplit5k9":	"1",
    "megasplit5k10":	"1",
    "megasplit5k18":	"1",
    "hardcore1":	"1",
    "hardcore2":	"1",
    "hardcore3":	"1",
    "hardcore5":	"1",
    "hardcore6":	"1",
    "hardcore7":	"1",
    "hardcore8":	"1",
    "hardcore9":	"1",
    "hardcore10":	"1",
    "hardcore12":	"1",
    "hardcore26":	"1",
    "extreme7":	"1",
    "hardcoreexp1":	"1",
    "hardcoreexp2":	"1",
    "hardcoreexp3":	"1",
    "hardcoreexp4":	"1",
    "hardcoreexp5":	"1",
    "hardcoreexp6":	"1",
    "hardcoreexp7":	"1",
    "hardcoreexp8":	"1",
    "hardcoreexp9":	"1",
    "hardcoreexp10":	"1",
    "hardcoreexp21":	"1",
    "hardcoreexp22":	"1",
    "hardcoreexp41":	"1",
    "hardcoreexp50":	"1",
    "zombie1":	"1",
    "dm1":	"1",
    "luna":	"1",
    "venera":	"1",
    "saturn":	"1",
    "slowserver":	"1",
    "paris":	"1",
    "turkey":	"1",
    "amsterdam":	"1",
    "moscow":	"1",
    "canada":	"1",
    "london":	"1",
    "siberia":	"1",
    "kiev":	"1",
    "minsk":	"1",
    "usa1-newyork":	"1",
    "usa2-newyork":	"1",
    "usa3-newyork":	"1",
    "singapore1":	"1",
    "toronto":	"1",
    "clanhousew.w":	"1",
    "clanhouse18-25":	"1",
    "clanhousefff":	"1",
    "clanhousefbi":	"1",
    "clanhouse•••":	"1",
    "clanhousedsm":	"1",
    "clanhousezzz":	"1",
    "clanhouse72":	"1",
    "clanhousezaw":	"1",
    "clanhousepvl":	"1",
    "clanhousedead":	"1",
    "clanhouser2b":	"1",
    "clanhouseng":	"1",
    "clanhouseyolka":	"1",
    "clanhousewin":	"1",
    "clanhousefan":	"1",
    "clanhouseup":	"1",
    "clanhouserzr":	"1",
    "clanhousehawk":	"1",
    "clanhousezogo":	"1",
    "clanhousegyg":	"1",
    "clanhousepav":	"1",
    "clanhousepride":	"1",
    "clanhouseaob":	"1",
    "clanhousenoteam1":	"1",
    "clanhousetournament":	"1",
    "clanhousetest":	"1"
};
if ('undefined' == typeof(settedlang)){ var settedlang = 'ru';}
if ('undefined' == typeof(isTyping)){ var isTyping = false;}

$.getScript('js/masonry.js', function() {
    //console.log('masonry loaded');
});

$.getScript('js/jquery-countdown.min.js', function() {
    //console.log('js countdown loaded');
});

/*========================++  CUT BELOW THIS LINE   ++======================================*/

//  Trigger map toggle on keydown

$(document).on("keydown", function(event){
    //console.log(event.which);
    //console.log(event);

    // toggle map if M pressed
    if (event.which == 77 && (!isTyping)){
        if(typeof yaCounter30886916 !== 'undefined') { yaCounter30886916.reachGoal('mapmet'); }
        smc.toggleServerMap();
    }
});

// bind map removal to close button

$(document).on('click', '#server-map .map-controls a', function(e){
    smc.destroyMap();
});


// server map creator
var smc = {

    // Map drawing
    
    createMap: function(){
        // get winners json and draw them
        smc.getJson(null, function(json){
            // sort json
            var winnerGroups = smc.groupByServerType(json.winners);
            smc.drawMap(json, winnerGroups, function(){

                //run countdown
                smc.runCountdown(json.nextPeriod);

                // run redraw interwal
                smc.startRedrawInterval(25000);
            });
        });
    },
    drawInnerMap: function(winnerGroups){

        var content = '';

        // get HTML
        for (var group in winnerGroups) {
            if (winnerGroups.hasOwnProperty(group)) {
                content += smc.drawBlock(winnerGroups[group], group);
            }
        }

        return content;
    },
    destroyMap: function(){
        smc.stopRedrawInterval();
        smc.stopCountdown();
        $( "#server-map" ).remove();
    },
    drawMap: function(originalJson, winnerGroups, callback){

        // get top json and draw them
        var topListJson = '';
        smc.getJson('shop_winners/long-period-tops.json', function(json){
            topListJson = json;
        });


        var mapControls =
            "<div class='map-controls'>" +
            '<a href="javascript:void(0)">'+
            'Press "M" to close map' +
            '</a>' +
            "</div>";

        var countdown = "<div class='countdown-container'><div class='countdown'></div></div>";

        var map =  $(
            "<div id='server-map'>" +
            mapControls +
            countdown+
            "<div class='map-inner clearfix'>" +
            smc.drawInnerMap(winnerGroups) +
            "</div>" +
            smc.drawTopList(topListJson) +
            "</div>");


        $('body').append(map);

        // organize blocks
        smc.initMasonry(winnerGroups);

        callback();

    },
    redrawMap: function(){

        var topListJson = '';
        smc.getJson('shop_winners/long-period-tops.json', function(json){
            topListJson = json;
        });

        smc.getJson(null, function(json){
            var winnerGroups = smc.groupByServerType(json.winners);

            var innerHtml = "<div class='map-inner clearfix'>" +
                smc.drawInnerMap(winnerGroups) +
                "</div>" +
                smc.drawTopList(topListJson);

            $('#server-map .map-inner').replaceWith(innerHtml);

            smc.initMasonry(winnerGroups);
        });

    },
    drawBlock: function(block, key){
        // get array of objects and iterate them with drawServer, then enclose into block div and return
        var content = '';
        block.forEach(function(server){
            content += smc.drawServer(server);
        });
        return content;
        //return '<div class="block clearfix " id="server-map-block-' + key + '">' + content + '</div>';
    },
    drawServer: function(server){
        // get server object and draw it in div

        var bgClanColor = server.clanPrefix ? 'background-color: ' + smc.getClanColor(server.clanPrefix) + ';' : '';
        var nicknameClanColor = server.clanPrefix ? 'color: ' + smc.getClanColor(server.clanPrefix) + ';' : '';
        var clanClass = server.clanPrefix ? ' clan ' : '';


        // primary info
        var img = server.skinId ? '<img src="http://petridish.pw/engine/serverskins/' + server.skinId  + '.png">' : '';
        var serv = '<div class="server-id">' + server.serverId + '</div>';
        var nickname = '<div class="nickname ' + (server.isPersonal ? 'clan' : '') + '" style="'+ nicknameClanColor +'">' + server.fullNickName + '</div>';
        //var clan = !server.isPersonal ? '<div class="clan-prefix">' + server.clanPrefix + '</div>' : '';
        var points = '<div class="score"><span>' + smc.txt.score[settedlang] + '</span>' + server.score + '</div>';
        //var lifetime = '<div class="life-interval"><span>' + smc.txt.lifeInterval[settedlang] + '</span>' + smc.getLifetime(server.lifeInterval) + '</div>';


        // hover info
        var playAt = '<div class="txt">'+ smc.txt.playAt[settedlang] + '</div>';
        var beat = '<div class="txt">'+ smc.txt.beatTheRecord[settedlang] + '</div>';
        //var record = '<div class="record">'+  + '<div>';

        var masonryClass = 'grid-item--width' +  window.serverImportanceList[server.serverId] + ' grid-item--height' +  window.serverImportanceList[server.serverId];


        var content =
            '<div class="server switch-server map-server grid-item ' + masonryClass + clanClass + '" data-server="' + server.serverId + '" style="' + bgClanColor + '">' +
                img +
                '<div class="map-serv-info">' +
                    serv +
                    nickname +
                    //clan +
                    points +
                    //lifetime +
                '</div>' +
                '<div class="map-serv-info hover-info">' +
                    playAt +
                    serv +
                    beat +
                    nickname +
                    points +
                        //lifetime +
                '</div>' +
            '</div>';
        return content;
    },
    toggleServerMap: function(){
        if ($('#server-map').length){
            //console.log('map is open');
            smc.destroyMap();
        } else {
            //console.log('map is closed');
            smc.createMap();
        }
    },

    // Tops list
    drawTopList: function(json){

        var winners = '<div id="long-winners"><h3>' + (settedlang == 'ru' ? 'Топ игроков' : 'Top players') +  '</h3><ol>';
        winners += json.reduce(function(previousValue, currentValue, index, array) {
            return previousValue + '<li>'
                + currentValue.nickname + ': <strong>' + currentValue.winsCount + '</strong>'
                + '</li>';
        }, '');
        winners += '</ol></div>';

        return winners;
    },



    //Masonry
    masonry: {},
    allMasonry: function(winnerGroups){
        smc.masonry.all = $('#server-map .map-inner').masonry({
            // options...
            itemSelector: '.grid-item',
            columnWidth: 100
        });
    },
    blockMasonry: function(key){
        smc.masonry[key] = $('#server-map-block-' +key).masonry({
            // options...
            itemSelector: '.grid-item',
            columnWidth: 100
        });
    },
    initMasonry: function(winnerGroups){
        smc.allMasonry(winnerGroups);
        /*for (var group in winnerGroups) {
            if (winnerGroups.hasOwnProperty(group)) {
                smc.blockMasonry(group);
            }
        }*/
    },


    // JSON operations
    
    getJson: function(url, callback){

        if (!url){
            url = 'shop_winners/4.json';
        }

        $.ajax({
            dataType: "json",
            url: url,
            async: false,
            success: function(obj) {
                return callback(obj);
            }
        });

    },
    getServerModeList: function(){
        // get server modes list by server name
        var list;
        if (window.serverModesList){
            list = window.serverModesList;
        } else {
            list = {};
            $('.server-list .server-item').toArray().forEach(
                function(el){
                    list[el.getAttribute('autorun')] = el.getAttribute('mode');
                }
            );
        }

        return list;
    },
    groupByServerType: function(winners){
        // group winners by server type
        var sorted = {}, mode, modeList = smc.getServerModeList();

        for (var server in winners) {
            if (winners.hasOwnProperty(server)) {
                // do stuff

                mode = modeList[server];

                if (!sorted[mode]){
                    sorted[mode] = [];
                }

                sorted[mode].push(winners[server]);
            }
        }

        //console.log(sorted);
        return sorted;
    },



    // all the other stuff
    getRandomColor: function() {
        var letters = 'ABCDEF'.split('');
        var color = '#';
        color += letters[Math.round(Math.random() * 5)];
        letters = '0123456789ABCDEF'.split('');
        for (var i = 0; i < 5; i++) {
            color += letters[Math.round(Math.random() * 15)];
        }
        return color;
    },



    // coundown and interval

    runCountdown: function(time){
        function printCountdownText(event){
            $(this).html(event.strftime(''
                + '  <span>%H</span> : '
                + '<span>%M</span> : '
                + '<span>%S</span>'));
        }

        function countdownFinishAction(event){
            //console.log('countdown finished');
            // redraw map
            smc.destroyMap();
            smc.createMap();
        }


        var nextPeriod = new Date(time);

        if (nextPeriod > new Date()){
            //console.log('initializing countdown to', nextPeriod);

            $('#server-map .countdown').countdown(nextPeriod)
                .on('update.countdown', printCountdownText)
                .on('finish.countdown', countdownFinishAction)
                .countdown('start');
        } else {
            //console.log('countdown time is outdated');
        }
    },
    stopCountdown: function(){
        $('#server-map .countdown').countdown('stop');
    },

    startRedrawInterval: function(delay){

        //console.log('INTERVAL STARTED');

        smc.timerId = setInterval(function() {
            //console.log('map redrawn by interval');
            smc.redrawMap();
        }, delay);
    },

    stopRedrawInterval: function(){
        clearInterval(smc.timerId);
    },


    clanColors: {},

    getClanColor: function(clan){
        if (!smc.clanColors[clan]){
            smc.clanColors[clan] = smc.getRandomColor();
        }
        return smc.clanColors[clan];
    },
    getLifetime: function(seconds){
        var date = new Date(null);
        date.setSeconds(seconds);
        return date.toISOString().substr(11, 8);
    },

    txt: {
        score: {
            ru: 'Счёт: ',
            en: 'Points: ',
            fr: 'Points: ',
            nl: 'Points: '
        },
        lifeInterval: {
            ru: 'Время: ',
            en: 'Time: ',
            fr: 'Time: ',
            nl: 'Time: '
        },
        playAt: {
            ru: 'Играть на',
            en: 'Play at',
            fr: 'Play at',
            nl: 'Play at'
        },
        beatTheRecord: {
            ru: 'и побить рекорд',
            en: 'and beat the record',
            fr: 'and beat the record',
            nl: 'and beat the record'
        }
    }
};



$(document).on('click', '.map-server.grid-item', function(event){
    smc.destroyMap();
});